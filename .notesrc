#!/usr/bin/env bash
# Attempt to append the appropriate extension to a filename, preferring gpg
# over txt.
buildfile() {
    # If an extension was given, use it.
    if [[ "$1" == *.* ]]; then
        echo "$1"
    # If no extension was given...
    else
        # ... try the file without any extension.
        if [ -e "$1" ]; then
            echo "$1"
        # ... try the file with a gpg extension.
        elif [ -e "$1".gpg ]; then
            echo "$1".gpg
        # ... use a txt extension.
        else
            echo "$1".txt
        fi
    fi
}

# Verify the note directory is defined and exists.
init() {
    if [ -z "$NOTEDIR" ]; then
        echo '$NOTEDIR is undefined.'
        return 2
    fi
    if [ ! -d "$NOTEDIR" ]; then
        mkdir -p "$NOTEDIR"
    fi
}

# Create or edit notes.
n() {
    if init; then
        # If no note was given, list the notes.
        if [ -z "$1" ]; then
            ls -1htr --color=always "$NOTEDIR"
        # If a note was given, open it.
        else
            filepath="$(buildfile "$NOTEDIR"/"$1")"
            filename=$(basename $filepath)
            fileext=${filename##*.}
            if echo "$NOTEXDGEXT" | grep -qw "$fileext"; then
                xdg-open "$filepath"
            else
                $EDITOR "$filepath"
            fi
        fi
    else
        return $?
    fi
}

# Find a note by title.
nf() {
    if init; then
        cd "$NOTEDIR"
        find . -iname "*$1*"
        cd "$OLDPWD"
    else
        return $?
    fi
}

# Search within notes.
ns() {
    if init; then
        if [ -z "$1" ]; then
            ls -1htr --color=always "$NOTEDIR"
            return $?
        fi
        cd "$NOTEDIR"
        grep -rin --exclude-dir=.git --color=always "$1"
        cd "$OLDPWD"
    else
        return $?
    fi
}
